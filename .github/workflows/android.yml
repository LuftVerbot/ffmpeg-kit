name: FFmpeg Build

on:
  push: null
  workflow_dispatch:
    inputs:
      NDK_VERSION:
        description: Android NDK
        required: true
        default: r28

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NDK_VERSION: ${{ github.event.inputs.NDK_VERSION || 'r25b' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: prerequisites
        run: ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --uninstall "cmake;3.10.2.4988404" "cmake;3.18.1"

      - name: Download NDK
        run: |
          curl -L "https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip" -o ndk.zip
          unzip -q ndk.zip
          echo "ANDROID_NDK_ROOT=$PWD/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV
      - name: install packages
        run: sudo apt-get install -y autoconf automake libtool pkg-config curl git doxygen nasm cmake gcc gperf texinfo yasm bison autogen wget autopoint meson ninja-build ragel groff gtk-doc-tools libtasn1-bin
      - name: Build FFmpeg
        run: |
          ./android.sh -d \
            --enable-android-media-codec \
            --enable-android-zlib \
            --enable-gmp \
            --disable-arm-v7a
      - name: Upload Build Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build.log

      - name: Upload FFmpeg AAR
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-kit
          path: prebuilt/bundle-android-aar/ffmpeg-kit/ffmpeg-kit.aar
